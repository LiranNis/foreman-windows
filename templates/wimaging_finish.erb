<%#
kind: finish
name: Wimaging finish
oses:
- Windows Server 2008
- Windows Server 2008 R2
- Windows Server 2012
- Windows Server 2012 R2
- Windows
# Parameters are expected to be set in Foreman (globally or per group/host)
params:
- windowsLicenseKey: ABCDE-ABCDE-ABCDE-ABCDE-ABCDE # Valid Windows license key
- windowsLicenseOwner: Company, INC # Legal owner of the Windows license key
- localAdminAccountDisabled: false
- ntpSever: time.windows.com,other.time.server
- domainJoinAccount: administrator@domain.com # use this account to join domain
- domainJoinAccountPassword: Password for the domain Admin account
- computerOU: OU=Computers,CN=domain,CN=com # Place the computer account in specified Organizational Unit
- computerDomain: domain.com # domain to join
- disableIPv6: false
- foremanDebug: false
%>
<%
  # safemode renderer does not support unary negation
  salt_enabled = @host.params['salt_master'] ? true : false
  chef_enabled = @host.respond_to?(:chef_proxy) && @host.chef_proxy
  foreman_debug = @host.params['foremanDebug'] == 'true' ? true : false
-%>

@echo off

<% unless @host.params['localAdminAccountDisabled'] -%>
  echo Activating administrator
  net user administrator /active:yes
<% end -%>

<% subnet = @host.subnet -%>
<% if subnet.respond_to?(:dhcp_boot_mode?) -%>
<% dhcp = subnet.dhcp_boot_mode? && !@static -%>
<% else -%>
<% dhcp = !@static -%>
<% end -%>

<% if !dhcp -%>
SETLOCAL EnableDelayedExpansion
set MainMAC=<%= @host.mac %>
set MainMAC=%MainMAC::=-%
for /f "delims=" %%a in ('ipconfig /all') do (
    set line=%%a
    if not "!line:~0,1!"==" " if not "!line:adapter=!"=="!line!" (
        set name=!line:*adapter =!
        set name=!name::=!
    )
    for /f "tokens=1,2,*" %%b in ("%%a") do (
        if "%%b %%c"=="Physical Address." (
            set mac=%%d
            set mac=!mac:*: =!
            echo !name!: !mac!
            call set mactest=%%MainMAC:!mac!=%%
            if not "!MainMAC!"=="!mactest!" (
                netsh int ip set address "!name!" source=static address=<%= @host.ip %> mask=<%= subnet.mask %> gateway=<%= subnet.gateway %>
				netsh int ip set dnsservers "!name!" source=static address=<%= subnet.dns_primary %>
<% if subnet.dns_secondary!="" -%>
				netsh int ip set dnsservers "!name!" source=static address=<%= subnet.dns_secondary %>
<% end -%>
            )
        )
    )
)
<% end -%>

<% if @host.params['disableIPv6'] -%>
  reg add "HKLM\SYSTEM\CurrentControlSet\Services\Tcpip6\Parameters" /t REG_DWORD /v DisabledComponent /d 0xFFFFFFFF /f
<% end -%>

<% if @host.pxe_build? %>
  set ctr=0
  set nettimeout=10

  (echo Updating time)
  (sc config w32time start= auto)
  sc start w32time
  :ntp_testip
    ::ipconfig /renew
    wget.exe <%= foreman_url('provision') %>
    if %errorlevel% == 0 goto ntp_testip_ok
    timeout /t 10 >NUL
    set /a ctr=ctr+1
    echo Retry network. Run %ctr% time(s)
    if %ctr% GTR %nettimeout% (
        echo Network error! Exiting.
        exit 1
        )
    goto ntp_testip
  :ntp_testip_ok

  echo Network test OK!

  <% if @host.params['ntpSever'] -%>
    echo setting time server
    w32tm /config /manualpeerlist:<%= @host.params['ntpSever'] %> /syncfromflags:manual /update
  <% end %>

  echo sync time
  w32tm /resync
  w32tm /resync

  :: You can join your machine to the domain right here >

  <% if @host.params['domainJoinAccount'] and @host.params['domainJoinAccountPassword'] -%>
    echo joining domain
    powershell.exe -OutputFormat text -ExecutionPolicy remotesigned -command c:\deploy\joinDomain.ps1
  <% end %>

  :: < You can join your machine to the domain right here

  <% if @host.params['localAdminAccountDisabled'] %>
    echo Disabling %tempAdminUser%
    net user %tempAdminUser% %tempAdminUser% /active:no
  <% end %>
  
  <% if foreman_debug != true -%>
    echo Safely remove wimaging files
    sdelete.exe -accepteula -p 2 -s c:\wimaging
    sdelete.exe -accepteula -p 2 c:\Windows\Panther\unattend.xml
    sdelete.exe -accepteula -p 2 C:\Windows\Setup\Scripts\SetupComplete.cmd
    sdelete.exe -accepteula -p 2 -s c:\minint
    sdelete.exe -accepteula -p 2 -s c:\wimaging
  <% end %>

  <% if snippets "Wimaging extraFinishCommands" -%>
    echo Running extra commands
    <%= snippets "Wimaging extraFinishCommands" %>
  <% end -%>
  
  <% unless @host.params['rundeckBuilt'] -%>
    echo Tell foreman build has finished
    wget.exe <%= foreman_url('built') %>
  <% end -%>

  <% if foreman_debug != true -%>
    echo Cleaning up extras
    sdelete.exe -accepteula -p 2 -s c:\extras
    
    echo rebooting in 10 seconds...
    shutdown /r /t 10
    
    echo Safely removing c:\deploy
    sdelete.exe -accepteula -p 2 -s c:\deploy
    
    echo Safely removing foreman.log
    sdelete.exe -accepteula -p 2 -s c:\foreman.log
  <% end -%>  
<% end -%>